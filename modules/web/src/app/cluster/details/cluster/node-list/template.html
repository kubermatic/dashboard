<!--
Copyright 2020 The Kubermatic Kubernetes Platform contributors.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<mat-card appearance="outlined">
  <mat-card-header>
    <mat-card-title>Nodes</mat-card-title>
  </mat-card-header>
  <mat-card-content>
    <table class="km-table"
           mat-table
           multiTemplateDataRows
           matSort
           (matSortChange)="onSortChange($event)"
           [dataSource]="dataSource">
      <ng-container [matColumnDef]="column.stateArrow">
        <th mat-header-cell
            *matHeaderCellDef
            class="km-header-cell"></th>
        <td mat-cell
            *matCellDef="let element">
          <i [ngClass]="isShowNodeItem[element.id] ? 'km-icon-mask km-icon-arrow-up' : 'km-icon-mask km-icon-arrow-down'"></i>
        </td>
      </ng-container>

      <ng-container [matColumnDef]="column.status">
        <th mat-header-cell
            *matHeaderCellDef
            class="km-header-cell"></th>
        <td mat-cell
            *matCellDef="let element">
          <i [matTooltip]="getNodeHealthStatus(element).message"
             [ngClass]="getNodeHealthStatus(element).icon"
             class="health-status"></i>
        </td>
      </ng-container>

      <ng-container [matColumnDef]="column.name">
        <th mat-header-cell
            *matHeaderCellDef
            class="km-header-cell p-35"
            mat-sort-header>Name</th>
        <td mat-cell
            *matCellDef="let element">
          <div fxLayout="row"
               fxLayoutAlign=" center">
            <span>{{element.spec.cloud.aws ? getNodeName(element) : element.name}}</span>
            @if (element.status.errorMessage; as errorMessage) {
            <i [matTooltip]="errorMessage"
               class="km-icon-warning"></i>
            } @else {
            @if (showInfo(element)) {
            <i class="km-icon-info km-pointer"
               matTooltip="{{getInfo(element)}}"></i>
            }
            }
          </div>
        </td>
      </ng-container>

      <ng-container [matColumnDef]="column.kubeletVersion">
        <th mat-header-cell
            *matHeaderCellDef
            class="km-header-cell p-15"
            mat-sort-header>kubelet Version</th>
        <td mat-cell
            *matCellDef="let element">{{element.status.nodeInfo.kubeletVersion}}</td>
      </ng-container>

      <ng-container [matColumnDef]="column.ipAddresses">
        <th mat-header-cell
            *matHeaderCellDef
            class="km-header-cell p-30">IP Addresses</th>
        <td mat-cell
            *matCellDef="let element">
          @if (element.status.addresses && getAddresses(element); as addresses) {
          <div fxLayout="column"
               fxLayoutGap="5px"
               [ngClass]="{'node-ip-addresses-spacing': (addresses.externalIPs.length && addresses.internalIPs.length) || addresses.internalIPs.length > 1 || addresses.externalIPs.length > 1}">
            @if (!!addresses.internalIPs.length) {
            <div fxLayout="row"
                 fxLayoutGap="5px">
              <span>Int. IP:</span>
              <div fxLayout="column">
                @for (internalIP of addresses.internalIPs; track internalIP) {
                <span class="km-copy"
                      [cbContent]="internalIP"
                      (click)="$event.stopPropagation()"
                      ngxClipboard
                      matTooltip="click to copy">{{internalIP}}</span>
                }
              </div>
            </div>
            }
            @if (!!addresses.externalIPs.length) {
            <div fxLayout="row"
                 fxLayoutGap="5px">
              <span>Ext. IP:</span>
              <div fxLayout="column">
                @for (externalIP of addresses.externalIPs; track externalIP) {
                <span class="km-copy"
                      [cbContent]="externalIP"
                      (click)="$event.stopPropagation()"
                      ngxClipboard
                      matTooltip="click to copy">{{externalIP}}</span>
                }
              </div>
            </div>
            }
          </div>
          }
        </td>
      </ng-container>

      <ng-container [matColumnDef]="column.creationDate">
        <th mat-header-cell
            *matHeaderCellDef
            class="km-header-cell p-15"
            mat-sort-header>Created</th>
        <td mat-cell
            *matCellDef="let element">
          <km-relative-time [date]="element.creationTimestamp" />
        </td>
      </ng-container>

      <ng-container [matColumnDef]="column.actions">
        <th mat-header-cell
            *matHeaderCellDef
            class="km-header-cell"></th>
        <td mat-cell
            *matCellDef="let element">
          <div fxLayoutAlign="end"
               class="km-table-actions">
            @switch (!!element.deletionTimestamp) {
            @case (true) {
            <mat-spinner [diameter]="25"
                         class="km-spinner"
                         color="accent" />
            }
            @case (false) {
            <button mat-icon-button
                    [attr.id]="'km-delete-node-' + element.name"
                    matTooltip="Delete Node"
                    (click)="deleteNodeDialog(element); $event.stopPropagation()"
                    [disabled]="!canDelete()">
              <i class="km-icon-mask km-icon-delete"></i>
            </button>
            }
            }
          </div>
        </td>
      </ng-container>

      <ng-container [matColumnDef]="toggleableColumn.nodeDetails">
        <td mat-cell
            *matCellDef="let element"
            class="node-details"
            [attr.colspan]="displayedColumns.length">
          <mat-card-content fxLayout="row wrap"
                            class="km-row">
            @if (!!element.status.nodeInfo.kernelVersion) {
            <km-property>
              <div key>Kernel Version</div>
              <div value>{{element.status.nodeInfo.kernelVersion}}</div>
            </km-property>
            }

            @if (!!element.status.nodeInfo.containerRuntimeVersion) {
            <km-property>
              <div key>Container Runtime Version</div>
              <div value>{{element.status.nodeInfo.containerRuntimeVersion}}</div>
            </km-property>
            }

            <!-- Node sizes for all providers. -->
            @if (element.spec.cloud.aws) {
            <km-property>
              <div key>Node Size</div>
              <div value>{{element.spec.cloud.aws.instanceType}}</div>
            </km-property>
            }
            @if (element.spec.cloud.azure) {
            <km-property>
              <div key>Node Size</div>
              <div value>{{element.spec.cloud.azure.size}}</div>
            </km-property>
            }
            @if (element.spec.cloud.digitalocean) {
            <km-property>
              <div key>Node Size</div>
              <div value>{{element.spec.cloud.digitalocean.size}}</div>
            </km-property>
            }
            @if (element.spec.cloud.hetzner) {
            <km-property>
              <div key>Node Size</div>
              <div value>{{element.spec.cloud.hetzner.type}}</div>
            </km-property>
            }
            @if (element.spec.cloud.openstack) {
            <km-property>
              <div key>Node Size</div>
              <div value>{{element.spec.cloud.openstack.flavor}}</div>
            </km-property>
            }

            @if (element.spec.cloud.alibaba) {
            <km-property>
              <div key>Instance Type</div>
              <div value>{{element.spec.cloud.alibaba.instanceType}}</div>
            </km-property>
            }
            <!-- End of node sizes.-->

            @if (!!element.status.capacity.cpu && !!element.status.capacity.memory) {
            <km-property>
              <div key>Node Capacity</div>
              <div value>
                {{element.status.capacity.cpu}} CPU, {{getFormattedNodeMemory(element.status.capacity.memory)}}
              </div>
            </km-property>
            }

            <km-property>
              <div value
                   fxLayout="row"
                   fxLayoutGap="10px">
                <div class="km-os-image-{{getSystemLogoClass(element)}}"></div>
                <span>{{getSystem(element)}}</span>
                @if (getSystem(element) === 'Container Linux') {
                <km-chip text="EOL"
                         type="error"
                         matTooltip="Container Linux has reached its end of life and is no longer maintained or updated." />
                }
              </div>
            </km-property>

            @if (element.spec.sshUserName) {
            <km-property>
              <div key
                   class="node-info"
                   matTooltip="Use this username if you need to connect to your nodes via SSH.">
                SSH Key Username
                <i class="km-icon-info km-pointer"></i>
              </div>
              <div value>{{element.spec.sshUserName}}</div>
            </km-property>
            }

            <!-- Other provider-specific properties. -->
            @if (element.spec.cloud.aws) {
            <km-property>
              <div key>Disk Type</div>
              <div value>{{element.spec.cloud.aws.volumeType}}</div>
            </km-property>
            }
            @if (element.spec.cloud.aws) {
            <km-property>
              <div key>Disk Size in GB</div>
              <div value>{{element.spec.cloud.aws.diskSize}}</div>
            </km-property>
            }
            @if (element.spec.cloud.aws?.ami) {
            <km-property>
              <div key>AMI ID</div>
              <div value>{{element.spec.cloud.aws.ami}}</div>
            </km-property>
            }
            @if (element.spec.cloud.aws?.spotInstanceMaxPrice) {
            <km-property>
              <div key>Spot Instance Max Price</div>
              <div value>{{element.spec.cloud.aws.spotInstanceMaxPrice | currency:'USD':'symbol':'1.0-4'}}</div>
            </km-property>
            }

            @if (element.spec.cloud.openstack) {
            <km-property>
              <div key>Node Image</div>
              <div value>{{element.spec.cloud.openstack.image}}</div>
            </km-property>
            }

            @if (element.spec.cloud.openstack?.availabilityZone) {
            <km-property>
              <div key>Availability Zone</div>
              <div value>{{element.spec.cloud.openstack.availabilityZone}}</div>
            </km-property>
            }
            @if (element.spec.cloud.openstack?.instanceReadyCheckPeriod) {
            <km-property>
              <div key>Instance Ready Check Period</div>
              <div value>{{element.spec.cloud.openstack.instanceReadyCheckPeriod}}</div>
            </km-property>
            }
            @if (element.spec.cloud.openstack?.instanceReadyCheckTimeout) {
            <km-property>
              <div key>Instance Ready Check Timeout</div>
              <div value>{{element.spec.cloud.openstack.instanceReadyCheckTimeout}}</div>
            </km-property>
            }
            @if (element.spec.cloud.openstack) {
            <km-property-boolean label="Config Drive"
                                 [value]="element.spec.cloud.openstack?.configDrive" />
            }

            @if (element.spec.cloud.kubevirt) {
            @if (element.spec.cloud.kubevirt.cpus) {
            <km-property>
              <div key>CPUs</div>
              <div value>{{element.spec.cloud.kubevirt.cpus}}</div>
            </km-property>
            }
            @if (element.spec.cloud.kubevirt.memory) {
            <km-property>
              <div key>Memory</div>
              <div value>{{element.spec.cloud.kubevirt.memory}}</div>
            </km-property>
            }
            @if (element.spec.cloud.kubevirt.instancetype; as instanceType) {
            <km-property>
              <div key>Instance Type</div>
              <div value>
                <mat-chip>
                  <div>{{getKubeVirtInstanceTypeCategory(instanceType)}}</div>
                  <div class="km-chip-accent">{{instanceType.name}}</div>
                </mat-chip>
              </div>
            </km-property>
            }
            @if (element.spec.cloud.kubevirt.preference; as preference) {
            <km-property>
              <div key>Preference</div>
              <div value>
                <mat-chip>
                  <div>{{getKubeVirtPreferenceCategory(preference)}}</div>
                  <div class="km-chip-accent">{{preference.name}}</div>
                </mat-chip>
              </div>
            </km-property>
            }
            <km-property>
              <div key>Operating System Image</div>
              <div value>{{element.spec.cloud.kubevirt.primaryDiskOSImage}}</div>
            </km-property>
            <km-property>
              <div key>Storage Class</div>
              <div value>{{element.spec.cloud.kubevirt.primaryDiskStorageClassName}}</div>
            </km-property>
            <km-property>
              <div key>Size</div>
              <div value>{{element.spec.cloud.kubevirt.primaryDiskSize}}</div>
            </km-property>
            @if (element.spec.cloud.kubevirt?.subnet) {
            <km-property>
              <div key>Subnet</div>
              <div value>{{element.spec.cloud.kubevirt.subnet}}</div>
            </km-property>
            }
            @if (element.spec.cloud.kubevirt.nodeAffinityPreset; as nodeAffinityPreset) {
            <km-property>
              <div key>Node Affinity Preset</div>
              <div value>{{nodeAffinityPreset.Type}}</div>
            </km-property>
            @if (nodeAffinityPreset.Key) {
            <km-property>
              <div key>Node Affinity Preset Key</div>
              <div value>{{nodeAffinityPreset.Key}}</div>
            </km-property>
            }
            @if (nodeAffinityPreset.Values?.length) {
            <km-property>
              <div key>Node Affinity Preset Values</div>
              <div value>{{nodeAffinityPreset.Values.join(', ')}}</div>
            </km-property>
            }
            }
            @if (element.spec.cloud.kubevirt.topologySpreadConstraints?.length > 0) {
            <km-property>
              <div key>Topology Spread Constraints</div>
              <div value>
                <mat-chip-set selectable="false">
                  @for (constraint of element.spec.cloud.kubevirt.topologySpreadConstraints; track constraint) {
                  <mat-chip>
                    <div>{{constraint.topologyKey}}</div>
                    <div class="km-chip-accent">{{constraint.maxSkew}}</div>
                    <div>{{constraint.whenUnsatisfiable}}</div>
                  </mat-chip>
                  }
                </mat-chip-set>
              </div>
            </km-property>
            }
            }

            @if (element.spec.cloud.vsphere) {
            <km-property>
              <div key>Number of CPUs</div>
              <div value>{{element.spec.cloud.vsphere.cpus}}</div>
            </km-property>
            }
            @if (element.spec.cloud.vsphere) {
            <km-property>
              <div key>Memory in MB</div>
              <div value>{{element.spec.cloud.vsphere.memory}}</div>
            </km-property>
            }
            @if (element.spec.cloud.vsphere?.diskSizeGB) {
            <km-property>
              <div key>Disk Size in GB</div>
              <div value>{{element.spec.cloud.vsphere.diskSizeGB}}</div>
            </km-property>
            }
            @if (element.spec.cloud.vsphere?.template) {
            <km-property>
              <div key>VM Template</div>
              <div value>{{element.spec.cloud.vsphere.template}}</div>
            </km-property>
            }
            @if (element.spec.cloud.vsphere?.vmGroup) {
            <km-property>
              <div key>VM Group</div>
              <div value>{{element.spec.cloud.vsphere.vmGroup}}</div>
            </km-property>
            }
            <km-property-boolean label="VM Anti Affinity"
                                 [value]="element.spec.cloud.vsphere?.vmAntiAffinity" />

            @if (element.spec.cloud.anexia?.cpus) {
            <km-property>
              <div key>Number of CPU's</div>
              <div value>{{element.spec.cloud.anexia.cpus}}</div>
            </km-property>
            }
            @if (element.spec.cloud.anexia?.memory) {
            <km-property>
              <div key>Memory in MB</div>
              <div value>{{element.spec.cloud.anexia.memory}}</div>
            </km-property>
            }
            @if (element.spec.cloud.anexia?.disks?.length > 0) {
            <km-property>
              <div key>Disks</div>
              <div value>
                <mat-chip-set selectable="false">
                  @for (disk of element.spec.cloud.anexia.disks; track disk) {
                  <mat-chip>
                    <div>{{disk.size}}GB</div>
                    @if (disk.performanceType) {
                    <div class="km-chip-accent">{{disk.performanceType}}</div>
                    }
                  </mat-chip>
                  }
                </mat-chip-set>
              </div>
            </km-property>
            }
            @if (element.spec.cloud.anexia?.templateID) {
            <km-property>
              <div key>Template ID</div>
              <div value>{{element.spec.cloud.anexia.templateID}}</div>
            </km-property>
            }
            @if (element.spec.cloud.anexia?.template) {
            <km-property>
              <div key>Template Name</div>
              <div value>{{element.spec.cloud.anexia.template}}</div>
            </km-property>
            }
            @if (element.spec.cloud.anexia?.vlanID) {
            <km-property>
              <div key>VLAN ID</div>
              <div value>{{element.spec.cloud.anexia.vlanID}}</div>
            </km-property>
            }

            @if (element.spec.cloud.azure?.zones?.length > 0) {
            <km-property>
              <div key>Zone</div>
              <div value>{{element.spec.cloud.azure.zones}}</div>
            </km-property>
            }
            @if (element.spec.cloud.azure?.imageID) {
            <km-property>
              <div key>Image ID</div>
              <div value>{{element.spec.cloud.azure.imageID}}</div>
            </km-property>
            }
            @if (element.spec.cloud.azure) {
            <km-property>
              <div key>Data Disk Size</div>
              @if (element.spec.cloud.azure.dataDiskSize === 0) {
              <div value>Default</div>
              }
              @if (element.spec.cloud.azure.dataDiskSize !== 0) {
              <div value>
                {{element.spec.cloud.azure.dataDiskSize}} GB
              </div>
              }
            </km-property>
            }
            @if (element.spec.cloud.azure) {
            <km-property>
              <div key>OS Disk Size</div>
              @if (element.spec.cloud.azure.osDiskSize === 0) {
              <div value>Default</div>
              }
              @if (element.spec.cloud.azure.osDiskSize !== 0) {
              <div value>
                {{element.spec.cloud.azure.osDiskSize}} GB
              </div>
              }
            </km-property>
            }

            @if (element.spec.cloud.baremetal?.tinkerbell) {
            @if (element.spec.cloud.baremetal.tinkerbell.hardwareRef?.Name) {
            <km-property>
              <div key>Hardware Name</div>
              <div value>{{ element.spec.cloud.baremetal.tinkerbell.hardwareRef?.Name }}</div>
            </km-property>
            }
            @if (element.spec.cloud.baremetal.tinkerbell.hardwareRef?.Namespace) {
            <km-property>
              <div key>Hardware Namespace</div>
              <div value>{{ element.spec.cloud.baremetal.tinkerbell.hardwareRef?.Namespace }}</div>
            </km-property>
            }
            <km-property>
              <div key>Operating System Image</div>
              <div value>{{ element.spec.cloud.baremetal.tinkerbell.osImageUrl }}</div>
            </km-property>
            }
            <!-- End of other properties. -->

            <!-- Tags for all providers. -->
            @if (element.spec.cloud.aws && hasTags(element.spec.cloud.aws.tags)) {
            <km-property>
              <div key>Tags</div>
              <div value>
                <km-labels [labels]="element.spec.cloud.aws.tags"
                           emptyMessage="No assigned tags" />
              </div>
            </km-property>
            }
            @if (element.spec.cloud.azure && hasTags(element.spec.cloud.azure.tags)) {
            <km-property>
              <div key>Tags</div>
              <div value>
                <km-labels [labels]="element.spec.cloud.azure.tags"
                           emptyMessage="No assigned tags" />
              </div>
            </km-property>
            }
            @if (element.spec.cloud.digitalocean && element.spec.cloud.digitalocean.tags.length > 0) {
            <km-property>
              <div key>Tags</div>
              <div value>
                <km-labels [labels]="element.spec.cloud.digitalocean.tags"
                           emptyMessage="No assigned tags" />
              </div>
            </km-property>
            }

            @if (element.spec.cloud.openstack && hasTags(element.spec.cloud.openstack.tags)) {
            <km-property>
              <div key>Tags</div>
              <div value>
                <km-labels [labels]="element.spec.cloud.openstack.tags"
                           emptyMessage="No assigned tags" />
              </div>
            </km-property>
            }

            @if (element.spec.cloud.vsphere && hasTags(element.spec.cloud.vsphere.tags)) {
            <km-property>
              <div key>Tags</div>
              <div value>
                <km-labels [labels]="convertVSphereTagsIntoObject(element.spec.cloud.vsphere.tags)"
                           emptyMessage="No assigned tags" />
              </div>
            </km-property>
            }
            <!-- End of tags.-->

            <!-- Boolean properties. -->
            @if (!!element.spec.operatingSystem.ubuntu) {
            <km-property-boolean label="Upgrade system on first boot"
                                 [value]="element.spec.operatingSystem.ubuntu.distUpgradeOnBoot" />
            }
            @if (!!element.spec.operatingSystem.flatcar) {
            <km-property-boolean label="Disable auto-update"
                                 [value]="element.spec.operatingSystem.flatcar.disableAutoUpdate" />
            }
            @if (!!element.spec.operatingSystem.amzn2) {
            <km-property-boolean label="Upgrade system on first boot"
                                 [value]="element.spec.operatingSystem.amzn2.distUpgradeOnBoot" />
            }
            @if (!!element.spec.operatingSystem.rhel) {
            <km-property-boolean label="Upgrade system on first boot"
                                 [value]="element.spec.operatingSystem.rhel.distUpgradeOnBoot" />
            }
            @if (!!element.spec.operatingSystem.rockylinux) {
            <km-property-boolean label="Upgrade system on first boot"
                                 [value]="element.spec.operatingSystem.rockylinux.distUpgradeOnBoot" />
            }
            @if (element.spec.cloud.digitalocean) {
            <km-property-boolean label="Backups"
                                 [value]="element.spec.cloud.digitalocean.backups" />
            }
            @if (element.spec.cloud.digitalocean) {
            <km-property-boolean label="Monitoring"
                                 [value]="element.spec.cloud.digitalocean.monitoring" />
            }
            @if (element.spec.cloud.azure) {
            <km-property-boolean label="Assign Public IP"
                                 [value]="element.spec.cloud.azure.assignPublicIP" />
            }
            @if (element.spec.cloud.azure) {
            <km-property-boolean label="Assign Availability Set"
                                 [value]="element.spec.cloud.azure.assignAvailabilitySet" />
            }
            @if (element.spec.cloud.aws) {
            <km-property-boolean label="Spot Instance"
                                 [value]="element.spec.cloud.aws.isSpotInstance" />
            }
            @if (element.spec.cloud.aws) {
            <km-property-boolean label="Spot Instance Persistent Request"
                                 [value]="element.spec.cloud.aws.spotInstancePersistentRequest" />
            }
            @if (element.spec.cloud.aws) {
            <km-property-boolean label="EBS Volume Encryption"
                                 [value]="element.spec.cloud.aws.ebsVolumeEncrypted" />
            }
            <!-- End of boolean properties. -->

            <!-- Provider labels -->
            @if (element.spec.labels) {
            <km-property>
              <div key>Labels</div>
              <div value>
                <km-labels [labels]="element.spec.labels"
                           emptyMessage="No assigned labels" />
              </div>
            </km-property>
            }
            <!-- End of provider labels -->

            @if (getMetrics(element.name)) {
            <div fxLayout="row">
              <km-property-usage name="Nodes CPU Usage"
                                 unit="millicores"
                                 [used]="getMetrics(element.name)?.cpuTotalMillicores"
                                 [total]="getMetrics(element.name)?.cpuAvailableMillicores" />
              <km-property-usage name="Nodes Memory Usage"
                                 unit="MiB"
                                 [used]="getMetrics(element.name)?.memoryTotalBytes"
                                 [total]="getMetrics(element.name).memoryAvailableBytes" />
            </div>
            }
          </mat-card-content>
        </td>
      </ng-container>

      <tr mat-header-row
          class="km-header-row"
          *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row
          *matRowDef="let row; columns: displayedColumns;"
          class="km-mat-row km-pointer"
          (click)="toggleNodeItem(row)"></tr>
      <tr mat-row
          *matRowDef="let row; let i=index; columns: toggleableColumns;"
          [ngClass]="isShowNodeItem[row.id] ? '' : 'km-hidden'"
          class="km-mat-row"></tr>
    </table>

    @if (!nodes || nodes.length === 0) {
    <div class="km-row km-empty-list-msg">No nodes available.</div>
    }

    <div [hidden]="!isPaginatorVisible()"
         class="km-paginator-container">
      <div fxLayout="row"
           fxLayoutAlign="flex-end center">
        <km-pagination-page-size />
        <mat-paginator showFirstLastButtons />
      </div>
    </div>
  </mat-card-content>
</mat-card>
