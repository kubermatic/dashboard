build:
  box: golang:1.8
  steps:
    - script:
        name: install node
        code: |
          curl -sL https://deb.nodesource.com/setup_8.x | bash -
          apt-get install -y nodejs
    - script:
        name: install bzip2
        code: |
          apt-get install -y bzip2
    - script:
        name: build install
        code: |
          make install
    - script:
        name: build dist
        code: |
          make dist
    - setup-go-workspace:
        package-dir: github.com/kubermatic/dashboard-v2
    - script:
        name: build fileserver binary
        code: |
          export GOPATH=/go/src/app/_gopath
          export GOBIN=$GOPATH/bin
          export PATH=$PWD/node_packages/.bin:$GOBIN:$PATH
          CGO_ENABLED=0 make build
    - script:
        name: copy to deployment directory
        code: cp -av dashboard-v2 "$WERCKER_OUTPUT_DIR"

push-hash-image:
    box: ubuntu:16.04
    steps:
    - script:
        code: |
          apt-get update
          apt-get install -y ca-certificates
    - internal/docker-scratch-push:
        name: push to docker hub
        author: Dr. Stefan Schimanski <stefan.schimanski@gmail.com>
        username: $USERNAME
        password: $PASSWORD
        tag: $WERCKER_GIT_COMMIT
        repository: kubermatic/ui-v2
        registry: https://registry.hub.docker.com
        cmd: /dashboard-v2

push-latest-image:
    box: ubuntu:16.04
    steps:
    - internal/docker-scratch-push:
        name: push to docker hub
        author: Dr. Stefan Schimanski <stefan.schimanski@gmail.com>
        username: $USERNAME
        password: $PASSWORD
        email: stefan.schimanski@gmail.com
        tag: latest
        repository: kubermatic/ui-v2
        registry: https://registry.hub.docker.com
        cmd: /dashboard-v2

deployment-update:
    box: ubuntu:16.04
    steps:
    - create-file:
        name: Create ca.pem
        filename: ca.pem
        overwrite: true
        content: $CERTIFICATE_AUTHORITY
    - create-file:
        name: Create admin.pem
        filename: admin.pem
        overwrite: true
        content: $CLIENT_CERTIFICATE
    - create-file:
        name: Create admin-key.pem
        filename: admin-key.pem
        overwrite: true
        content: $CLIENT_KEY
    - kubectl:
        server: $KUBERNETES_MASTER
        username: $KUBERNETES_USERNAME
        password: $KUBERNETES_PASSWORD
        certificate-authority: ca.pem
        client-certificate: admin.pem
        client-key: admin-key.pem
        command: set image deployment/kubermatic-api-v2 api=kubermatic/api:$WERCKER_GIT_COMMIT --namespace=api
